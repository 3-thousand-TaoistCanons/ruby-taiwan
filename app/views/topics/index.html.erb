<%= render 'base' %>
<% content_for :sitemap do %>
  <% if params[:action] == "recent" %>
    <li class="active">主题列表</li>
  <% elsif params[:action] == "search" %>
    <li class="active">搜索<%= h params[:s] %></li>
  <% else %>
    <li class="active">活跃帖子</li>
  <% end %>
<% end %>

<%= render 'sidebar' %>
<div class="content">
	<div class="box">
    <% if !@node.blank? %>
    <div id="node_info">
      <p>
        <h1><%= h @node.name %></h1>
        <span class="total">共有 <%= @node.topics_count %> 个讨论主题</span>
      </p>
    </div>
    <% else %>
      <h1><%= Setting.app_name %></h1>
    <% end %>

    <div class="topics">
      <% @topics.each do |topic| %>
        <div class="topic topic_line">
          <div class="pull-left avatar">
            <%= user_avatar_tag(topic.user,:normal) %>
          </div>
          <div class="right_info">
            <div class="pull-right replies">
              <% if topic.replies.count > 0 %>
              <% readed_state = topic.user_readed?(current_user.id) if current_user %>
              <a href="<%= topic_path(topic.id) %><%= "#reply#{topic.replies_count}" %>" rel="twipsy" title="<%= topic_use_readed_text(readed_state) if current_user %>" class="count state<%= readed_state if current_user %>">
              <%= topic.replies_count %>
              </a>
              <% end %>
            </div>
            <div class="infos">
              <div class="title"><a href="<%= topic_path(topic) %>" title="<%= topic.title %>"><%= truncate(topic.title, :length => 100) %></a></div>
              <div class="info leader">
                由 <%= user_name_tag(topic.user) %>
                在 <a href="<%= node_topics_path(topic.node_id) %>"><%= topic.node.name %></a> 中发起
              </div>
              <div class="info time">
                <% if topic.last_reply_user.blank? %>
                  发布于 <%= timeago(topic.created_at) %>
                <% else %>
                  最后由 <%= user_name_tag(topic.last_reply_user) %> 回复于 <%= timeago(topic.replied_at) %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
      
    <% if params[:action] == "index" %>
      <div class="more">
        <a href="<%= recent_topics_path %>">查看更多最近发布的帖子...</a>
      </div>
    <% else %>
      <%= will_paginate1 @topics %>
    <% end %>
	</div>
	<% if params[:action] == "index" %>
	<div id="sections" class="box">
	<h2>讨论节点分类导航</h2>
	<ul>
		<% @sections.each do |section| %>
		<li>
			<label><%= section.name %></label>
			<% section.nodes.each do |node| %>
			<a href="<%= node_topics_path(node.id) %>" title="<%= node.name %>"><%= node.name %></a>
			<% end %>
		</li>
		<% end %>
	</ul>
	</div>
	<% end %>
</div>

